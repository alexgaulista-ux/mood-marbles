<script>
  const senhaCorreta = "Duroline001*"; // Defina uma senha correta
  const API_URL = "https://mood-marbles-api1.alexgaulista.workers.dev";

  // Função para registrar sentimentos
  function registrar(sentimento) {
    const setor = document.getElementById("setor").value;
    if (!setor) return alert("Selecione o setor");
    fetch(API_URL + "/registrar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ setor, sentimento })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.mensagem || "Registro realizado!");
      document.getElementById("setor").value = "";
    });
  }

  // Função para mostrar resultados
  function verResultados() {
    const senha = document.getElementById("senha").value;
    if (senha !== senhaCorreta) return alert("Senha incorreta!");
    fetch(API_URL + "/resultados")
      .then(res => res.json())
      .then(data => mostrarGraficos(data));
  }

  // Função para exportar PDF
  async function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Captura todos os gráficos gerados
    const canvasElements = document.querySelectorAll("canvas");
    canvasElements.forEach((canvas, index) => {
      const imgData = canvas.toDataURL("image/png", 1.0);
      doc.addImage(imgData, "PNG", 10, 10 + (index * 90), 180, 80);
    });

    // Título e lista de votos
    let y = canvasElements.length ? 10 + (canvasElements.length * 90) : 20;
    doc.setFontSize(16);
    doc.text("Relatório - Mood Marbles", 10, y);
    y += 10;

    const data = await fetch(API_URL + "/resultados").then(r => r.json());
    data.forEach(item => {
      doc.setFontSize(12);
      doc.text(`${item.setor} - ${item.sentimento}: ${item.total}`, 10, y);
      y += 8;
    });

    doc.save("relatorio.pdf");
  }
</script>
