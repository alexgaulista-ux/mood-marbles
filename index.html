<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Como est√° o clima do time?</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; padding: 20px; }
    select, button, input[type="password"], input[type="text"] { padding: 10px; font-size: 16px; margin: 10px; }
    .mood { display: inline-block; margin: 15px; width: 100px; height: 100px; border-radius: 50%; cursor: pointer; line-height: 100px; color: white; font-weight: bold; font-size: 50px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s; }
    .mood:hover { transform: scale(1.1); }
    .op1 { background-color: #28a745; } .op2 { background-color: #007bff; } .op3 { background-color: #ffc107; color: black; } .op4 { background-color: #dc3545; } .op5 { background-color: #8B0000; }
    #login, #resultados, #acoes { margin-top: 30px; display: none; }
    canvas { max-width: 400px; margin: auto; }
  </style>
</head>
<body>
  <h1>Como est√° o seu dia hoje?</h1>
  <label for="setor">Selecione seu setor:</label>
  <select id="setor">
    <option value="">-- Escolha --</option>
    <option value="administrativo">Administrativo</option>
    <option value="expedicao">Expedi√ß√£o</option>
    <option value="rh">RH</option>
    <option value="fiscal">Fiscal</option>
    <option value="fabrica">F√°brica</option>
    <option value="engenharia">Engenharia</option>
    <option value="manutencao">Manuten√ß√£o</option>
    <option value="comercial">Comercial</option>
    <option value="apoio">Apoio</option>
  </select>

  <div id="moods">
    <div class="mood op1" onclick="registrar('excelente')">üòÄ</div>
    <div class="mood op2" onclick="registrar('bom')">üôÇ</div>
    <div class="mood op3" onclick="registrar('neutro')">üòê</div>
    <div class="mood op4" onclick="registrar('ruim')">üôÅ</div>
    <div class="mood op5" onclick="registrar('raiva')">üò†</div>
  </div>

  <button onclick="mostrarLogin()">üîí Acesso Restrito</button>

  <div id="login">
    <p>Usu√°rio:</p>
    <input type="text" id="usuario">
    <p>Senha:</p>
    <input type="password" id="senha">

    <p>
      <label for="filtro_data">Filtrar por per√≠odo:</label>
      <select id="filtro_data">
        <option value="hoje">Hoje</option>
        <option value="semana">√öltimos 7 dias</option>
        <option value="todos" selected>Todos</option>
      </select>
    </p>

    <button onclick="verResultados()">Ver Resultados</button>
    <button onclick="limparRegistros()" style="margin-left: 15px; background-color: #dc3545; color: white;">üóëÔ∏è Limpar Registros</button>
  </div>

  <div id="acoes">
    <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
  </div>

  <div id="resultados"></div>

  <script>
    const API_URL = "https://mood-marbles-api1.alexgaulista.workers.dev";

    function registrar(sentimento) {
      const setor = document.getElementById("setor").value;
      if (!setor) return alert("Selecione o setor");
      fetch(API_URL + "/registrar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ setor, sentimento })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.mensagem || "Registro realizado!");
        document.getElementById("setor").value = "";
      });
    }

    function mostrarLogin() {
      document.getElementById("login").style.display = "block";
    }

    async function verResultados() {
      const usuario = document.getElementById("usuario").value;
      const senha = document.getElementById("senha").value;
      const filtro = document.getElementById("filtro_data").value;

      if (!usuario || !senha) {
        alert("Informe usu√°rio e senha para ver resultados.");
        return;
      }

      const resp = await fetch(API_URL + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, senha })
      });
      const data = await resp.json();

      if (!data.sucesso) return alert("Usu√°rio ou senha incorretos!");

      const res = await fetch(API_URL + `/resultados?filtro=${filtro}`);
      const resultados = await res.json();
      mostrarGraficos(resultados);
    }

    function mostrarGraficos(data) {
      const sentimentos = ['excelente', 'bom', 'neutro', 'ruim', 'raiva'];
      const setores = [...new Set(data.map(r => r.setor))];
      const container = document.getElementById("resultados");
      container.innerHTML = "<h2>Resultados por Setor</h2>";
      setores.forEach(setor => {
        const grupo = data.filter(d => d.setor === setor);
        const valores = sentimentos.map(k => {
          const item = grupo.find(g => g.sentimento === k);
          return item ? item.total : 0;
        });

        const div = document.createElement("div");
        div.innerHTML = `<h3>${setor}</h3><canvas id="chart_${setor}"></canvas><hr>`;
        container.appendChild(div);

        new Chart(document.getElementById(`chart_${setor}`), {
          type: 'pie',
          data: {
            labels: sentimentos,
            datasets: [{
              data: valores,
              backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545', '#8B0000']
            }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      });
      document.getElementById("resultados").style.display = "block";
      document.getElementById("acoes").style.display = "block";
    }

    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Relat√≥rio de Clima por Setor", 20, 20);

      const filtro = document.getElementById("filtro_data")?.value || "todos";
      const resp = await fetch(API_URL + `/resultados?filtro=${filtro}`);
      const data = await resp.json();
      let y = 30;

      const sentimentos = ['excelente', 'bom', 'neutro', 'ruim', 'raiva'];
      const setores = [...new Set(data.map(r => r.setor))];
      setores.forEach(setor => {
        const grupo = data.filter(d => d.setor === setor);
        let total = grupo.reduce((sum, g) => sum + g.total, 0);

        doc.setFontSize(12);
        doc.text(`${setor.toUpperCase()}:`, 20, y);
        y += 8;

        sentimentos.forEach(sent => {
          const item = grupo.find(g => g.sentimento === sent);
          if (!item) return;
          const perc = total > 0 ? ((item.total / total) * 100).toFixed(1) : 0;
          doc.setFontSize(10);
          doc.text(`  ${sent}: ${item.total} (${perc}%)`, 25, y);
          y += 6;
        });

        y += 4;
        if (y > 270) { doc.addPage(); y = 20; }
      });

      doc.save("relatorio_clima_setores.pdf");
    }

    async function limparRegistros() {
      if (!confirm("Tem certeza que deseja apagar todos os registros?")) return;

      const usuario = document.getElementById("usuario").value;
      const senha = document.getElementById("senha").value;

      if (!usuario || !senha) {
        alert("Informe usu√°rio e senha para limpar registros.");
        return;
      }

      // Login para autenticar
      const resp = await fetch(API_URL + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, senha })
      });
      const data = await resp.json();
      if (!data.sucesso) return alert("Usu√°rio ou senha incorretos!");

      // Chama endpoint limpar
      const res = await fetch(API_URL + "/limpar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario })
      });
      const result = await res.json();
      alert(result.mensagem || "Registros apagados!");

      document.getElementById("resultados").style.display = "none";
      document.getElementById("acoes").style.display = "none";
    }
  </script>
</body>
</html>
