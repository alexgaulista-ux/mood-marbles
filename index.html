<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Como está o clima do time?</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; padding: 20px; }
    select, button, input[type="password"], input[type="text"] { padding: 10px; font-size: 16px; margin: 10px; }
    .mood { display: inline-block; margin: 15px; width: 100px; height: 100px; border-radius: 50%; cursor: pointer; line-height: 100px; color: white; font-weight: bold; font-size: 50px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s; }
    .mood:hover { transform: scale(1.1); }
    .op1 { background-color: #28a745; } .op2 { background-color: #007bff; } .op3 { background-color: #ffc107; color: black; } .op4 { background-color: #dc3545; } .op5 { background-color: #8B0000; }
    #login, #resultados, #acoes { margin-top: 30px; display: none; }
    canvas { max-width: 400px; margin: auto; }
  </style>
</head>
<body>
  <h1>Como está o seu dia hoje?</h1>
  <label for="setor">Selecione seu setor:</label>
  <select id="setor">
    <option value="">-- Escolha --</option>
    <option value="administrativo">Administrativo</option>
    <option value="expedicao">Expedição</option>
    <option value="rh">RH</option>
    <option value="fiscal">Fiscal</option>
    <option value="fabrica">Fábrica</option>
    <option value="engenharia">Engenharia</option>
    <option value="manutencao">Manutenção</option>
    <option value="comercial">Comercial</option>
    <option value="apoio">Apoio</option>
  </select>

  <div id="moods">
    <div class="mood op1" onclick="registrar('excelente')">😀</div>
    <div class="mood op2" onclick="registrar('bom')">🙂</div>
    <div class="mood op3" onclick="registrar('neutro')">😐</div>
    <div class="mood op4" onclick="registrar('ruim')">🙁</div>
    <div class="mood op5" onclick="registrar('raiva')">😠</div>
  </div>

  <button onclick="mostrarLogin()">🔒 Acesso Restrito</button>

  <div id="login">
    <p>Usuário:</p>
    <input type="text" id="usuario">
    <p>Senha:</p>
    <input type="password" id="senha">
    <p></p><button onclick="verResultados()">Ver Resultados</button></p>
  </div>

  <div id="acoes">
    <button onclick="exportarPDF()">📄 Exportar PDF</button>
  </div>

  <div id="resultados"></div>

  <script>
    const API_URL = "https://mood-marbles-api1.alexgaulista.workers.dev";

    function registrar(sentimento) {
      const setor = document.getElementById("setor").value;
      if (!setor) return alert("Selecione o setor");
      fetch(API_URL + "/registrar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ setor, sentimento })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.mensagem || "Registro realizado!");
        document.getElementById("setor").value = "";
      });
    }

    function mostrarLogin() {
      document.getElementById("login").style.display = "block";
    }

    async function verResultados() {
      const usuario = document.getElementById("usuario").value;
      const senha = document.getElementById("senha").value;

      const resp = await fetch(API_URL + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, senha })
      });
      const data = await resp.json();

      if (!data.sucesso) return alert("Usuário ou senha incorretos!");

      const res = await fetch(API_URL + "/resultados");
      const resultados = await res.json();
      mostrarGraficos(resultados);
    }

    function mostrarGraficos(data) {
      const setores = [...new Set(data.map(r => r.setor))];
      const container = document.getElementById("resultados");
      container.innerHTML = "<h2>Resultados por Setor</h2>";
      setores.forEach(setor => {
        const grupo = data.filter(d => d.setor === setor);
        const valores = ['Excelente','op2','op3','op4','op5'].map(k => {
          const item = grupo.find(g => g.sentimento === k);
          return item ? item.total : 0;
        });

        const div = document.createElement("div");
        div.innerHTML = `<h3>${setor}</h3><canvas id="chart_${setor}"></canvas><hr>`;
        container.appendChild(div);

        new Chart(document.getElementById(`chart_${setor}`), {
          type: 'pie',
          data: {
            labels: ['excelente', 'bom', 'neutro', 'ruim', 'raiva'],
            datasets: [{
              data: valores,
              backgroundColor: ['#28a745', '#007bff', '#ffc107', '#dc3545', '#8B0000']
            }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      });
      document.getElementById("resultados").style.display = "block";
      document.getElementById("acoes").style.display = "block";
    }

    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Relatório de Clima por Setor", 20, 20);

      const resp = await fetch(API_URL + "/resultados");
      const data = await resp.json();
      let y = 30;

      const setores = [...new Set(data.map(r => r.setor))];
      setores.forEach(setor => {
        const grupo = data.filter(d => d.setor === setor);
        let total = grupo.reduce((sum, g) => sum + g.total, 0);

        doc.setFontSize(12);
        doc.text(`${setor.toUpperCase()}:`, 20, y);
        y += 8;

        grupo.forEach(item => {
          const perc = total > 0 ? ((item.total / total) * 100).toFixed(1) : 0;
          doc.setFontSize(10);
          doc.text(`  ${item.sentimento}: ${item.total} (${perc}%)`, 25, y);
          y += 6;
        });

        y += 4;
        if (y > 270) { doc.addPage(); y = 20; }
      });

      doc.save("relatorio_clima_setores.pdf");
    }
  </script>
</body>
</html>
